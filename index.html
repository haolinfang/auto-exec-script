<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç¼–è¯‘è„šæœ¬æ‰§è¡Œå™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        /* è¡¨å•è¡Œ - æ ‡ç­¾å’Œæ§ä»¶åœ¨åŒä¸€è¡Œ */
        .form-row {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .form-item {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        /* å¤é€‰æ¡†å®¹å™¨ */
        .checkbox-item {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .form-label {
            font-weight: bold;
            color: #34495e;
            white-space: nowrap;
            margin-right: 10px;
            min-width: 80px;
            text-align: right;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #34495e;
        }
        
        .checkbox-label input {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        select, input {
            padding: 10px 12px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s;
            flex: 1;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        button {
            padding: 14px 20px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 10px 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.3);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #output {
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            border: 2px solid #333;
            border-radius: 8px;
            text-align: left;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.5;
            color: #e0e0e0;
            font-size: 13px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        
        #output .success { color: #4CAF50; }
        #output .error { color: #f44336; }
        #output .warning { color: #ff9800; }
        #output .info { color: #2196F3; }
        #output .timestamp { color: #888; }
        
        .status {
            font-weight: bold;
            margin: 20px;
            font-size: 18px;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .success { 
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        .error { 
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .warning { 
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .loading {
            display: none;
            margin: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info {
            color: #666;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .controls {
            margin: 5px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 5px 20px;
            font-size: 14px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .control-btn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                margin: 20px;
            }
            
            .container {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .form-item, .checkbox-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-label {
                text-align: left;
                margin-bottom: 5px;
                min-width: auto;
            }
            
            .checkbox-label {
                width: 100%;
            }
            
            select, input {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        
        /* ç‰ˆæœ¬å·é€‰æ‹©å™¨æ ·å¼ */
        optgroup {
            font-weight: bold;
            color: #2c3e50;
        }
        
        option {
            padding: 8px;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        #output::-webkit-scrollbar {
            width: 10px;
        }
        
        #output::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 5px;
        }
        
        #output::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        #output::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç§»åŠ¨åº”ç”¨ç¼–è¯‘å·¥å…·</h1>
        <p class="info">é€‰æ‹©ç¼–è¯‘ç±»å‹å’Œç‰ˆæœ¬å·ï¼Œç‚¹å‡»"å¼€å§‹ç¼–è¯‘"æŒ‰é’®è¿›è¡Œç¼–è¯‘æ“ä½œ</p>
        
        <!-- ç¬¬ä¸€è¡Œï¼šç¼–è¯‘ç±»å‹å’Œç‰ˆæœ¬å· -->
        <div class="form-row">
            <div class="form-item">
                <span class="form-label">ç¼–è¯‘ç±»å‹:</span>
                <select id="type">
                    <option value="android">Android</option>
                    <option value="ios">iOS</option>
                </select>
            </div>
            
            <div class="form-item">
                <span class="form-label">ç‰ˆæœ¬å·:</span>
                <select id="version">
                    <optgroup label="Android">
                        <option value="2.4.9">2.4.9</option>
                        <option value="2.5.3" selected>2.5.3</option>
                    </optgroup>
                    <optgroup label="iOS">
                        <option value="2.0.5">2.0.5</option>
                        <option value="2.5.3">2.5.3</option>
                    </optgroup>
                </select>
            </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šå¤é€‰æ¡†å’Œçƒ­æ›´æ–°æè¿° -->
        <div class="form-row">
            <div class="checkbox-item">
                <div class="checkbox-label">
                    <input type="checkbox" id="pushHotUpdate" checked>
                    <span>ç¼–è¯‘å®Œæˆåè‡ªåŠ¨æ¨é€çƒ­æ›´æ–°</span>
                </div>
            </div>
            
            <div class="form-item">
                <span class="form-label">çƒ­æ›´æ–°æè¿°:</span>
                <input type="text" id="hotUpdateDesc" placeholder="è‡ªåŠ¨ç¼–è¯‘æ¨é€">
            </div>
        </div>
        
        <button id="runBtn">ğŸš€ å¼€å§‹ç¼–è¯‘</button>
        
        <div class="controls">
            <button id="clearBtn" class="control-btn">ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º</button>
            <button id="scrollBtn" class="control-btn">ğŸ“œ è‡ªåŠ¨æ»šåŠ¨</button>
            <button id="stopBtn" class="control-btn" disabled>â¹ï¸ åœæ­¢ç¼–è¯‘</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨ç¼–è¯‘ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="output">
ç­‰å¾…ç¼–è¯‘...
        </div>
        
        <div class="info">
            <p>ğŸ”¹ ç¼–è¯‘è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
            <p>ğŸ”¹ è¾“å‡ºåŒºåŸŸä¼šå®æ—¶æ˜¾ç¤ºç¼–è¯‘è¿›åº¦å’Œæ—¥å¿—ä¿¡æ¯</p>
            <p>ğŸ”¹ å¯éšæ—¶ä½¿ç”¨"åœæ­¢ç¼–è¯‘"æŒ‰é’®ä¸­æ–­å½“å‰ç¼–è¯‘ä»»åŠ¡</p>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentController = null;
        let autoScrollEnabled = true;
        
        // è·å–DOMå…ƒç´ 
        const runBtn = document.getElementById('runBtn');
        const clearBtn = document.getElementById('clearBtn');
        const scrollBtn = document.getElementById('scrollBtn');
        const stopBtn = document.getElementById('stopBtn');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        
        // æ ¼å¼åŒ–æ—¶é—´æˆ³
        function getTimestamp() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        // æ·»åŠ è¾“å‡ºè¡Œ
        function addOutputLine(text, className = '') {
            const timestamp = `<span class="timestamp">[${getTimestamp()}]</span>`;
            const line = document.createElement('div');
            line.innerHTML = timestamp + ' ' + text;
            if (className) {
                line.className = className;
            }
            output.appendChild(line);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (autoScrollEnabled) {
                output.scrollTop = output.scrollHeight;
            }
        }
        
        // æ¸…ç©ºè¾“å‡º
        clearBtn.addEventListener('click', () => {
            output.innerHTML = '';
            addOutputLine('è¾“å‡ºå·²æ¸…ç©º', 'info');
        });
        
        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        scrollBtn.addEventListener('click', () => {
            autoScrollEnabled = !autoScrollEnabled;
            scrollBtn.textContent = autoScrollEnabled ? 'ğŸ“œ è‡ªåŠ¨æ»šåŠ¨' : 'ğŸ“œ æ‰‹åŠ¨æ»šåŠ¨';
            scrollBtn.style.background = autoScrollEnabled ? '#6c757d' : '#ff9800';
            
            if (autoScrollEnabled) {
                output.scrollTop = output.scrollHeight;
            }
        });
        
        // åœæ­¢ç¼–è¯‘
        stopBtn.addEventListener('click', () => {
            if (currentController) {
                currentController.abort();
                addOutputLine('ç¼–è¯‘å·²åœæ­¢', 'warning');
                runBtn.disabled = false;
                runBtn.textContent = 'ğŸš€ å¼€å§‹ç¼–è¯‘';
                loading.style.display = 'none';
                stopBtn.disabled = true;
                status.textContent = 'âš ï¸ ç¼–è¯‘å·²åœæ­¢';
                status.className = 'status warning';
            }
        });
        
        // å¼€å§‹ç¼–è¯‘
        runBtn.addEventListener('click', function() {
            const btn = this;
            const type = document.getElementById('type').value;
            const version = document.getElementById('version').value;
            const pushHotUpdate = document.getElementById('pushHotUpdate').checked;
            const hotUpdateDesc = document.getElementById('hotUpdateDesc').value || "è‡ªåŠ¨ç¼–è¯‘æ¨é€";
            
            // éªŒè¯ç‰ˆæœ¬å·é€‰æ‹©æ˜¯å¦åŒ¹é…
            if ((type === 'android' && !['2.4.9', '2.5.3'].includes(version)) ||
                (type === 'ios' && !['2.0.5', '2.5.3'].includes(version))) {
                alert(`é”™è¯¯ï¼š${type} ä¸æ”¯æŒç‰ˆæœ¬ ${version}\n\nAndroidæ”¯æŒï¼š2.4.9, 2.5.3\niOSæ”¯æŒï¼š2.0.5, 2.5.3`);
                return;
            }
            
            // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
            output.innerHTML = '';
            
            // æ˜¾ç¤ºåˆå§‹ä¿¡æ¯
            addOutputLine(`å¼€å§‹ç¼–è¯‘ ${type} ${version}...`, 'info');
            addOutputLine(`çƒ­æ›´æ–°æ¨é€: ${pushHotUpdate ? 'æ˜¯' : 'å¦'}`, 'info');
            if (pushHotUpdate) {
                let desc = hotUpdateDesc;
                if (desc === "è‡ªåŠ¨ç¼–è¯‘æ¨é€") {
                    desc = `è‡ªåŠ¨ç¼–è¯‘æ¨é€ ${type} ${version}`;
                }
                addOutputLine(`çƒ­æ›´æ–°æè¿°: ${desc}`, 'info');
            }
            addOutputLine('='.repeat(50), 'info');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.textContent = 'â³ ç¼–è¯‘ä¸­...';
            loading.style.display = 'block';
            status.textContent = 'ğŸ”„ ç¼–è¯‘è¿›è¡Œä¸­...';
            status.className = 'status';
            stopBtn.disabled = false;
            scrollBtn.disabled = false;
            
            // åˆ›å»ºAbortControllerä»¥ä¾¿å¯ä»¥å–æ¶ˆè¯·æ±‚
            currentController = new AbortController();
            const signal = currentController.signal;
            
            // æ„å»ºURLå‚æ•°
            const params = new URLSearchParams({
                type: type,
                version: version,
                push: pushHotUpdate,
                desc: hotUpdateDesc === "è‡ªåŠ¨ç¼–è¯‘æ¨é€" ? `è‡ªåŠ¨ç¼–è¯‘æ¨é€ ${type} ${version}` : hotUpdateDesc
            });
            
            // ä½¿ç”¨fetchæµå¼è¯»å–å“åº”
            fetch(`/compile?${params.toString()}`, {
                signal: signal
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                
                // è¯»å–æµæ•°æ®
                function readStream() {
                    return reader.read().then(({done, value}) => {
                        if (done) {
                            return;
                        }
                        
                        // è§£ç å¹¶æ˜¾ç¤ºæ•°æ®
                        const text = decoder.decode(value, {stream: true});
                        if (text.trim()) {
                            // æ ¹æ®å†…å®¹ç±»å‹æ·»åŠ é¢œè‰²
                            const lines = text.split('\n');
                            lines.forEach(line => {
                                if (line.trim()) {
                                    let className = '';
                                    if (line.includes('[SUCCESS]') || line.includes('âœ…') || line.includes('æˆåŠŸ')) {
                                        className = 'success';
                                    } else if (line.includes('[ERROR]') || line.includes('âŒ') || line.includes('å¤±è´¥') || line.includes('é”™è¯¯')) {
                                        className = 'error';
                                    } else if (line.includes('[WARNING]') || line.includes('âš ï¸') || line.includes('è­¦å‘Š')) {
                                        className = 'warning';
                                    } else if (line.includes('[INFO]')) {
                                        className = 'info';
                                    }
                                    addOutputLine(line, className);
                                }
                            });
                        }
                        
                        // ç»§ç»­è¯»å–
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .then(() => {
                // æµè¯»å–å®Œæˆ
                addOutputLine('='.repeat(50), 'info');
                addOutputLine('âœ… ç¼–è¯‘å®Œæˆï¼', 'success');
                status.textContent = 'âœ… ç¼–è¯‘å®Œæˆ';
                status.className = 'status success';
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('è¯·æ±‚å·²ä¸­æ­¢');
                    return;
                }
                
                console.error('ç¼–è¯‘é”™è¯¯:', error);
                addOutputLine(`âŒ é”™è¯¯: ${error.message}`, 'error');
                status.textContent = 'âŒ ç¼–è¯‘å¤±è´¥';
                status.className = 'status error';
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ å¼€å§‹ç¼–è¯‘';
                loading.style.display = 'none';
                stopBtn.disabled = true;
                currentController = null;
            });
        });
        
        // å½“ç±»å‹æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬
        document.getElementById('type').addEventListener('change', function() {
            const type = this.value;
            const versionSelect = document.getElementById('version');
            
            // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤ç‰ˆæœ¬
            if (type === 'android') {
                versionSelect.value = '2.5.3';
            } else {
                versionSelect.value = '2.0.5';
            }
        });
        
        // åˆå§‹åŒ–
        addOutputLine('å°±ç»ª - é€‰æ‹©å‚æ•°åç‚¹å‡»"å¼€å§‹ç¼–è¯‘"æŒ‰é’®', 'info');
    </script>
</body>
</html>